<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>python、sql、pyspark计算常用风控指标 | 栗子是个Rapper</title>
    <meta name="generator" content="VuePress 1.9.9">
    <link rel="icon" href="/img/favicon.ico">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/katex.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/2.10.0/github-markdown.min.css">
    <meta name="description" content="风控、算法、编程、生活">
    <meta name="keywords" content="风控、算法、编程、生活">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/assets/css/0.styles.53e6cd70.css" as="style"><link rel="preload" href="/assets/js/app.3258d765.js" as="script"><link rel="preload" href="/assets/js/2.c22fde0b.js" as="script"><link rel="preload" href="/assets/js/15.21c3caba.js" as="script"><link rel="prefetch" href="/assets/js/10.ac3ce773.js"><link rel="prefetch" href="/assets/js/11.14bddee2.js"><link rel="prefetch" href="/assets/js/12.e794371c.js"><link rel="prefetch" href="/assets/js/13.eb64dfa2.js"><link rel="prefetch" href="/assets/js/14.b5bf0437.js"><link rel="prefetch" href="/assets/js/16.ed9cd402.js"><link rel="prefetch" href="/assets/js/17.901f401e.js"><link rel="prefetch" href="/assets/js/18.354e823e.js"><link rel="prefetch" href="/assets/js/19.56e35adb.js"><link rel="prefetch" href="/assets/js/3.e12e5c13.js"><link rel="prefetch" href="/assets/js/4.d7a5b7f7.js"><link rel="prefetch" href="/assets/js/5.2a872229.js"><link rel="prefetch" href="/assets/js/6.ec192408.js"><link rel="prefetch" href="/assets/js/7.2f72de17.js"><link rel="prefetch" href="/assets/js/8.4705bb34.js"><link rel="prefetch" href="/assets/js/9.c7bf1364.js">
    <link rel="stylesheet" href="/assets/css/0.styles.53e6cd70.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu only-sidebarItem"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/logo.png" alt="栗子是个Rapper" class="logo"> <span class="site-name can-hide">栗子是个Rapper</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="风控" class="dropdown-title"><a href="/risk/" class="link-title">风控</a> <span class="title" style="display:none;">风控</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>OldSchool</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/note/riskbasis/" class="nav-link">风控基础</a></li></ul></li><li class="dropdown-item"><h4>NewSchool</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/note/riskalgs/" class="nav-link">风控模型</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="算法" class="dropdown-title"><a href="/alg/" class="link-title">算法</a> <span class="title" style="display:none;">算法</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>数据结构与算法</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/note/LeetCode/" class="nav-link">LeetCode</a></li></ul></li><li class="dropdown-item"><h4>机器学习</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/note/ml/" class="nav-link">机器学习</a></li><li class="dropdown-subitem"><a href="/note/dl/" class="nav-link">深度学习</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="技术" class="dropdown-title"><a href="/technology/" class="link-title">技术</a> <span class="title" style="display:none;">技术</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>编程</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/note/Python/" class="nav-link">Python</a></li><li class="dropdown-subitem"><a href="/note/Scala/" class="nav-link">Scala</a></li></ul></li><li class="dropdown-item"><h4>大数据</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/note/Spark/" class="nav-link">Spark</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="量化" class="dropdown-title"><a href="/quant/" class="link-title">量化</a> <span class="title" style="display:none;">量化</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/note/fundamentals.html" class="nav-link">基本面</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="更多" class="dropdown-title"><a href="/more/" class="link-title">更多</a> <span class="title" style="display:none;">更多</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/friends/" class="nav-link">友情链接</a></li></ul></div></div><div class="nav-item"><a href="/about/" class="nav-link">关于</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="收藏" class="dropdown-title"><a href="/note/collect/" class="link-title">收藏</a> <span class="title" style="display:none;">收藏</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/note/collect/website.html" class="nav-link">常用网址</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/aka-chestnut/my-vuepress" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="/img/potrait.png"> <div class="blogger-info"><h3>AKA栗子</h3> <span>不劳而获暴富，无本万利躺赢</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="风控" class="dropdown-title"><a href="/risk/" class="link-title">风控</a> <span class="title" style="display:none;">风控</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>OldSchool</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/note/riskbasis/" class="nav-link">风控基础</a></li></ul></li><li class="dropdown-item"><h4>NewSchool</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/note/riskalgs/" class="nav-link">风控模型</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="算法" class="dropdown-title"><a href="/alg/" class="link-title">算法</a> <span class="title" style="display:none;">算法</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>数据结构与算法</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/note/LeetCode/" class="nav-link">LeetCode</a></li></ul></li><li class="dropdown-item"><h4>机器学习</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/note/ml/" class="nav-link">机器学习</a></li><li class="dropdown-subitem"><a href="/note/dl/" class="nav-link">深度学习</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="技术" class="dropdown-title"><a href="/technology/" class="link-title">技术</a> <span class="title" style="display:none;">技术</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>编程</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/note/Python/" class="nav-link">Python</a></li><li class="dropdown-subitem"><a href="/note/Scala/" class="nav-link">Scala</a></li></ul></li><li class="dropdown-item"><h4>大数据</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/note/Spark/" class="nav-link">Spark</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="量化" class="dropdown-title"><a href="/quant/" class="link-title">量化</a> <span class="title" style="display:none;">量化</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/note/fundamentals.html" class="nav-link">基本面</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="更多" class="dropdown-title"><a href="/more/" class="link-title">更多</a> <span class="title" style="display:none;">更多</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/friends/" class="nav-link">友情链接</a></li></ul></div></div><div class="nav-item"><a href="/about/" class="nav-link">关于</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="收藏" class="dropdown-title"><a href="/note/collect/" class="link-title">收藏</a> <span class="title" style="display:none;">收藏</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/note/collect/website.html" class="nav-link">常用网址</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/aka-chestnut/my-vuepress" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><a href="/pages/riskcal/" aria-current="page" class="active sidebar-link">python、sql、pyspark计算常用风控指标</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/pages/riskcal/#_1-sql-计算-ks" class="sidebar-link">1. SQL 计算 KS</a></li><li class="sidebar-sub-header level2"><a href="/pages/riskcal/#_2-python-计算-ks" class="sidebar-link">2. Python 计算 KS</a></li><li class="sidebar-sub-header level2"><a href="/pages/riskcal/#_3-pyspark-计算-ks" class="sidebar-link">3. Pyspark 计算 KS</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level1"><a href="/pages/riskcal/#二、auc" class="sidebar-link">二、AUC</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/riskcal/#_1-sql-计算-auc" class="sidebar-link">1. SQL 计算 AUC</a></li><li class="sidebar-sub-header level2"><a href="/pages/riskcal/#_2-python-计算-auc" class="sidebar-link">2. Python 计算 AUC</a></li><li class="sidebar-sub-header level2"><a href="/pages/riskcal/#_3-pyspark-计算-auc" class="sidebar-link">3. Pyspark 计算 AUC</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level1"><a href="/pages/riskcal/#三、psi" class="sidebar-link">三、PSI</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/riskcal/#_1-sql-计算-psi" class="sidebar-link">1. SQL 计算 PSI</a></li><li class="sidebar-sub-header level2"><a href="/pages/riskcal/#_2-python-计算-psi" class="sidebar-link">2. Python 计算 PSI</a></li><li class="sidebar-sub-header level2"><a href="/pages/riskcal/#_3-pyspark-计算-psi" class="sidebar-link">3. Pyspark 计算 PSI</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level1"><a href="/pages/riskcal/#参考资料" class="sidebar-link">参考资料</a></li></ul></li></ul></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06225672><div class="articleInfo" data-v-06225672><ul class="breadcrumbs" data-v-06225672><li data-v-06225672><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-06225672></a></li> <li data-v-06225672><a href="/note/riskbasis/#风控基础" data-v-06225672>风控基础</a></li></ul> <div class="info" data-v-06225672><div title="作者" class="author iconfont icon-touxiang" data-v-06225672><a href="https://github.com/aka-chestnut" target="_blank" title="作者" class="beLink" data-v-06225672>aka-chestnut</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-06225672><a href="javascript:;" data-v-06225672>2023-12-27</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABKFJREFUSA3tVl1oFVcQnrMbrak3QUgkya1akpJYcrUtIqW1JvFBE9LiQ5v6JmJpolbMg32rVrhgoYK0QiMY6i9Y6EMaW5D+xFJaTYItIuK2Kr3+BJNwkxBj05sQY3b3nM6cs2dv9t7NT/vQJw/sndk5M/PNzJkzewGerP+pAmy+ON8lLzUJgA8ZYxYIYZmGYRnctDaWvJJAmTtfP1pvXsBCCPP8QFcCaRkZYACgDZFO4stNIcBCajEOlmmC9XpJ9bAGCaPaPmzPl32dvLSVu3BWCTQs0XQQ6g0DYgwLIoAZbBCdW/i+781o1VVlm/410mw4h06Y7bIPHNyWDyL4FHkX03Q8SrzNhZTZriieckWt7cL6MM85YcLpsi/7O9/iXFT6MswI0DmmpkSaJ0qLxFIm3+i1THHB3zmBH3PYx9CcykcLOeQVVa7QtdxTgQgEleX2AjHYfwA+2ddV77ruGoJUbhGDI09YSNXyMpUt5ylOzxgbUmtOp7NmbNt8v3arjTBfYELmLUV+M+nSawNNAUqpT3ClJWg5I3BLT+cGW/DXNGCa6tx1aakCGEigArTn4TDIPdrXXYKCZNrHLMCOEPvHBlLQ99s9eHB7EB6NTki73CVPQ2F5MSx/uRQixfmq7rK0wYD8w8E905bnPDfwoWs/rfv93NWN/ZfvwsLIU7A09gxECyISeGJkHAau98L97tuw7NXnoPyNF8FcYGLGKsOs0mN3OEyec9esGW/ZEl945dTP34wlR2FZVQWU1q0Cw8Tr7p+hgLLNL0FPxx/Q35mA8aEUrH6nCgwEl0tn7wUiZYJnNRh6DK4UH/k0lfyrsBKdPVv/AriGIQcEDQZ65LBAGe2Rzui9Ybjz7XUppz1/uKBbyVPGkN3ZAeC6hr0x7Nr38N5+EqkoOm17xpoqR9ohQF55ERSvr4Dkr3chNfC3DMzGJlNBElW8w9nsGQvhNGIzDkXzCg8cLK951xHsFBlTJspJNi3ZFIMF2AeDV3q8DNOB+YHi6QTrChDIWDBRi5U5f+ZMfJLu3ccrqxtdxk4SKH336LFxSmkqefwU5T8fhdSdQf9IVKD6aNiwI/hnmcAZ91isYMJIaCUCx9W098+LgruikeTqzqqxKPUwqJyCPJiyemVVZBOijDGjD38Os0jOiSPL1z3SPjXNANbiNPXAdzTfukjjuknNBbyz3nwgTd3AVFqUJ5hpHlq9MveLnWwttUfoygBmvVjuikxND3znrhsELnZk7k+OjIGxeNEkomyLVta0xxn+HZhjBc4YZ/AFjHjz9u3xRZl2BN4aq9nFwWh16IrQ1aHHEd3j1+4/dB9OtH4e29A2H1DyHQRmOSfQZ1Fy7MHBTGB6J/Djq6p3OxyO2cB+4Car7v/o3GXgfAkj23+x9ID1Teoamo/SXcbvSf2PX7Vc8DdCmE1vN9di+32P9/5YR3vLnhCVGUWBjEkr3yh4H8v9CzmsbdhzOKzsJKM90iFdaTMjRPhGVsakRvOaRidljo6H6G7j+ctrJpsP+4COhDIl0La2+FS4+5mlocBaXY5QnGZysIBYoeSsl5qQzrSj/cgNrfuEzlWBfwA+EjrZyWUvpAAAAABJRU5ErkJggg==">python、sql、pyspark计算常用风控指标<!----></h1>  <div class="theme-vdoing-content content__default"><p>KS，AUC 和 PSI 是风控算法中最常计算的几个指标，本文记录了多种工具计算这些指标的方法。</p> <p>生成本文的测试数据：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">import</span> pandas <span class="token keyword">as</span> pd 
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> pyspark<span class="token punctuation">.</span>sql<span class="token punctuation">.</span>functions <span class="token keyword">as</span> F
<span class="token keyword">from</span> pyspark<span class="token punctuation">.</span>sql<span class="token punctuation">.</span>window <span class="token keyword">import</span> Window
<span class="token keyword">from</span> pyspark<span class="token punctuation">.</span>sql<span class="token punctuation">.</span>types <span class="token keyword">import</span> StringType<span class="token punctuation">,</span> DoubleType
<span class="token keyword">from</span> pyspark<span class="token punctuation">.</span>sql <span class="token keyword">import</span> SparkSession<span class="token punctuation">,</span> functions
<span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>metrics <span class="token keyword">import</span> roc_auc_score<span class="token punctuation">,</span>roc_curve


tmptable <span class="token operator">=</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">'y'</span><span class="token punctuation">:</span><span class="token punctuation">[</span>np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1000000</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
tmptable<span class="token punctuation">[</span><span class="token string">'y'</span><span class="token punctuation">]</span> <span class="token operator">=</span> tmptable<span class="token punctuation">[</span><span class="token string">'score'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">apply</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span><span class="token number">1</span> <span class="token keyword">if</span> np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>rand<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span>x<span class="token operator">&gt;</span><span class="token number">0.8</span> <span class="token keyword">else</span> <span class="token number">0</span><span class="token punctuation">)</span>
tmp_sparkdf <span class="token operator">=</span> spark<span class="token punctuation">.</span>createDataFrame<span class="token punctuation">(</span>tmptable<span class="token punctuation">)</span>
tmp_sparkdf<span class="token punctuation">.</span>craeteOrReplaceTempView<span class="token punctuation">(</span><span class="token string">'tmpview'</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h1 id="一、ks"><a href="#一、ks" class="header-anchor">#</a> 一、KS</h1> <p>​KS 指标来源于 <strong>Kolmogorov-Smirnov</strong> 检验，通常用于比较两组样本是否来源于同一分布。在建模中划分训练集与测试集后，通常运用 KS 检验来检验训练集与测试集的分布差异，如果分布差异过大，那可能就会因为训练集、测试集划分不合理而降低模型的泛化性。（<a href="https://www.cnblogs.com/arkenstone/p/5496761.html" target="_blank" rel="noopener noreferrer">关于 KS 检验的更多细节<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>）</p> <p>在风控中，KS 指标通过来衡量模型对于好坏样本的区分能力，其具体的算法为：</p> <ol><li>按模型分从小到大排序，并分为 n 组（等频分组或每个不同的分值作为一组）</li> <li>计算截至每一组的累积好样本(y=0)占比与累积坏样本(y=1)占比，记为 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>c</mi><mi>u</mi><mi>m</mi><mi>g</mi><mi>o</mi><mi>o</mi><mi>d</mi><mi>r</mi><mi>a</mi><mi>t</mi><mi>i</mi><msub><mi>o</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">cumgoodratio_i</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="strut" style="height:0.69444em;"></span><span class="strut bottom" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="base textstyle uncramped"><span class="mord mathit">c</span><span class="mord mathit">u</span><span class="mord mathit">m</span><span class="mord mathit" style="margin-right:0.03588em;">g</span><span class="mord mathit">o</span><span class="mord mathit">o</span><span class="mord mathit">d</span><span class="mord mathit" style="margin-right:0.02778em;">r</span><span class="mord mathit">a</span><span class="mord mathit">t</span><span class="mord mathit">i</span><span class="mord"><span class="mord mathit">o</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathit">i</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span></span> 和 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>c</mi><mi>u</mi><mi>m</mi><mi>b</mi><mi>a</mi><mi>d</mi><mi>r</mi><mi>a</mi><mi>t</mi><mi>i</mi><msub><mi>o</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">cumbadratio_i</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="strut" style="height:0.69444em;"></span><span class="strut bottom" style="height:0.84444em;vertical-align:-0.15em;"></span><span class="base textstyle uncramped"><span class="mord mathit">c</span><span class="mord mathit">u</span><span class="mord mathit">m</span><span class="mord mathit">b</span><span class="mord mathit">a</span><span class="mord mathit">d</span><span class="mord mathit" style="margin-right:0.02778em;">r</span><span class="mord mathit">a</span><span class="mord mathit">t</span><span class="mord mathit">i</span><span class="mord"><span class="mord mathit">o</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathit">i</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span></span><br>
如第 k 组：<br>
累积好样本占比=第 k 组前包括第 k 组 y=0 样本数量 / 全部 y=0 样本的数量<br>
累积坏样本占比=第 k 组前包括第 k 组 y=1 样本数量 / 全部 y=1 样本的数量</li> <li>则 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>K</mi><mi>S</mi><mo>=</mo><mi>m</mi><mi>a</mi><mi>x</mi><mo>(</mo><mi>a</mi><mi>b</mi><mi>s</mi><mo>(</mo><mi>c</mi><mi>u</mi><mi>m</mi><mi>g</mi><mi>o</mi><mi>o</mi><mi>d</mi><mi>r</mi><mi>a</mi><mi>t</mi><mi>i</mi><msub><mi>o</mi><mi>i</mi></msub><mo>−</mo><mi>c</mi><mi>u</mi><mi>m</mi><mi>b</mi><mi>a</mi><mi>d</mi><mi>r</mi><mi>a</mi><mi>t</mi><mi>i</mi><msub><mi>o</mi><mi>i</mi></msub><mo>)</mo><mo>)</mo></mrow><annotation encoding="application/x-tex">KS=max(abs(cumgoodratio_i-cumbadratio_i))</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="strut" style="height:0.75em;"></span><span class="strut bottom" style="height:1em;vertical-align:-0.25em;"></span><span class="base textstyle uncramped"><span class="mord mathit" style="margin-right:0.07153em;">K</span><span class="mord mathit" style="margin-right:0.05764em;">S</span><span class="mrel">=</span><span class="mord mathit">m</span><span class="mord mathit">a</span><span class="mord mathit">x</span><span class="mopen">(</span><span class="mord mathit">a</span><span class="mord mathit">b</span><span class="mord mathit">s</span><span class="mopen">(</span><span class="mord mathit">c</span><span class="mord mathit">u</span><span class="mord mathit">m</span><span class="mord mathit" style="margin-right:0.03588em;">g</span><span class="mord mathit">o</span><span class="mord mathit">o</span><span class="mord mathit">d</span><span class="mord mathit" style="margin-right:0.02778em;">r</span><span class="mord mathit">a</span><span class="mord mathit">t</span><span class="mord mathit">i</span><span class="mord"><span class="mord mathit">o</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathit">i</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mbin">−</span><span class="mord mathit">c</span><span class="mord mathit">u</span><span class="mord mathit">m</span><span class="mord mathit">b</span><span class="mord mathit">a</span><span class="mord mathit">d</span><span class="mord mathit" style="margin-right:0.02778em;">r</span><span class="mord mathit">a</span><span class="mord mathit">t</span><span class="mord mathit">i</span><span class="mord"><span class="mord mathit">o</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathit">i</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mclose">)</span><span class="mclose">)</span></span></span></span></li></ol> <h2 id="_1-sql-计算-ks"><a href="#_1-sql-计算-ks" class="header-anchor">#</a> 1. SQL 计算 KS</h2> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">select</span> <span class="token function">max</span><span class="token punctuation">(</span>abs<span class="token punctuation">(</span>cumgood<span class="token operator">/</span>totalgood<span class="token operator">-</span>cumbad<span class="token operator">/</span>totalbad<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">as</span> ks
<span class="token keyword">from</span> <span class="token punctuation">(</span>
    <span class="token keyword">select</span> score<span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span>totalbad<span class="token punctuation">)</span><span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">order</span> <span class="token keyword">by</span> score<span class="token punctuation">)</span> <span class="token keyword">as</span> cumbad<span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span>totalgood<span class="token punctuation">)</span><span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">order</span> <span class="token keyword">by</span> score<span class="token punctuation">)</span> <span class="token keyword">as</span> cumgood<span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span>totalbad<span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> totalbad<span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span>totalgood<span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> totalgood
    <span class="token keyword">from</span> <span class="token punctuation">(</span>
        <span class="token keyword">select</span> 
        score<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>y<span class="token punctuation">)</span> <span class="token keyword">as</span> totalbad<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">-</span>y<span class="token punctuation">)</span> <span class="token keyword">as</span> totalgood
        <span class="token keyword">from</span> tmpview
        <span class="token keyword">group</span> <span class="token keyword">by</span> score
    <span class="token punctuation">)</span>
<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h2 id="_2-python-计算-ks"><a href="#_2-python-计算-ks" class="header-anchor">#</a> 2. Python 计算 KS</h2> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">get_ks</span><span class="token punctuation">(</span>y_true<span class="token punctuation">:</span>pd<span class="token punctuation">.</span>Series<span class="token punctuation">,</span>y_pred<span class="token punctuation">:</span>pd<span class="token punctuation">.</span>Series<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">'''
    A staticmethod to caculate the KS of the model.
    Args:
        y_true: true value of the sample
        y_pred: pred value of the sample
  
    Returns:
        max(tpr-fpr): KS of the model
    '''</span>
    fpr<span class="token punctuation">,</span>tpr<span class="token punctuation">,</span>_ <span class="token operator">=</span> roc_curve<span class="token punctuation">(</span>y_true<span class="token punctuation">,</span>y_pred<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token builtin">str</span><span class="token punctuation">(</span><span class="token builtin">max</span><span class="token punctuation">(</span><span class="token builtin">abs</span><span class="token punctuation">(</span>tpr<span class="token operator">-</span>fpr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
ksdata <span class="token operator">=</span> spark<span class="token punctuation">.</span>sql<span class="token punctuation">(</span><span class="token string">'select * from tmpview'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toPandas<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>get_ks<span class="token punctuation">(</span>ksdata<span class="token punctuation">[</span><span class="token string">'y'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>ksdata<span class="token punctuation">[</span><span class="token string">'score'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h2 id="_3-pyspark-计算-ks"><a href="#_3-pyspark-计算-ks" class="header-anchor">#</a> 3. Pyspark 计算 KS</h2> <p>有两种方法，1 是对用 pyspark 的语法把 SQL 的逻辑给写出来，可以算出来 KS；2 就是包装成 UDF 函数，这样当需要 groupby 后计算 KS 时，可以直接调用 UDF 函数分组计算 KS</p> <p><strong>a. SQL 逻辑改写</strong></p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>ksdata <span class="token operator">=</span> spark<span class="token punctuation">.</span>sql<span class="token punctuation">(</span><span class="token string">'select * from tmpview'</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">calks</span><span class="token punctuation">(</span>df<span class="token punctuation">,</span>ycol<span class="token operator">=</span><span class="token string">'y'</span><span class="token punctuation">,</span>scorecol<span class="token operator">=</span><span class="token string">'score'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> df<span class="token punctuation">.</span>withColumn<span class="token punctuation">(</span>ycol<span class="token punctuation">,</span>F<span class="token punctuation">.</span>col<span class="token punctuation">(</span>ycol<span class="token punctuation">)</span><span class="token punctuation">.</span>cast<span class="token punctuation">(</span><span class="token string">'int'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>withColumn<span class="token punctuation">(</span>scorecol<span class="token punctuation">,</span>F<span class="token punctuation">.</span>col<span class="token punctuation">(</span>scorecol<span class="token punctuation">)</span><span class="token punctuation">.</span>cast<span class="token punctuation">(</span><span class="token string">'float'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\
        <span class="token punctuation">.</span>withColumn<span class="token punctuation">(</span><span class="token string">'totalbad'</span><span class="token punctuation">,</span>F<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>F<span class="token punctuation">.</span>col<span class="token punctuation">(</span>ycol<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>over<span class="token punctuation">(</span>Window<span class="token punctuation">.</span>orderBy<span class="token punctuation">(</span>F<span class="token punctuation">.</span>lit<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\
        <span class="token punctuation">.</span>withColumn<span class="token punctuation">(</span><span class="token string">'totalgood'</span><span class="token punctuation">,</span>F<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">-</span>F<span class="token punctuation">.</span>col<span class="token punctuation">(</span>ycol<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>over<span class="token punctuation">(</span>Window<span class="token punctuation">.</span>orderBy<span class="token punctuation">(</span>F<span class="token punctuation">.</span>lit<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\
        <span class="token punctuation">.</span>withColumn<span class="token punctuation">(</span><span class="token string">'cumgood'</span><span class="token punctuation">,</span>F<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">-</span>F<span class="token punctuation">.</span>col<span class="token punctuation">(</span>ycol<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>over<span class="token punctuation">(</span>Window<span class="token punctuation">.</span>orderBy<span class="token punctuation">(</span>F<span class="token punctuation">.</span>col<span class="token punctuation">(</span>scorecol<span class="token punctuation">)</span><span class="token punctuation">.</span>asc<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\
        <span class="token punctuation">.</span>withColumn<span class="token punctuation">(</span><span class="token string">'cumbad'</span><span class="token punctuation">,</span>F<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>F<span class="token punctuation">.</span>col<span class="token punctuation">(</span>ycol<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>over<span class="token punctuation">(</span>Window<span class="token punctuation">.</span>orderBy<span class="token punctuation">(</span>F<span class="token punctuation">.</span>col<span class="token punctuation">(</span>scorecol<span class="token punctuation">)</span><span class="token punctuation">.</span>asc<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\
        <span class="token punctuation">.</span>select<span class="token punctuation">(</span>F<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span>F<span class="token punctuation">.</span><span class="token builtin">abs</span><span class="token punctuation">(</span>F<span class="token punctuation">.</span>col<span class="token punctuation">(</span><span class="token string">'cumgood'</span><span class="token punctuation">)</span><span class="token operator">/</span>F<span class="token punctuation">.</span>col<span class="token punctuation">(</span><span class="token string">'totalgood'</span><span class="token punctuation">)</span><span class="token operator">-</span>F<span class="token punctuation">.</span>col<span class="token punctuation">(</span><span class="token string">'cumbad'</span><span class="token punctuation">)</span><span class="token operator">/</span>F<span class="token punctuation">.</span>col<span class="token punctuation">(</span><span class="token string">'totalbad'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>alias<span class="token punctuation">(</span><span class="token string">'KS'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
calks<span class="token punctuation">(</span>ksdata<span class="token punctuation">)</span><span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p><strong>b. python 转 UDF 函数</strong></p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">get_ks</span><span class="token punctuation">(</span>y_true<span class="token punctuation">:</span>pd<span class="token punctuation">.</span>Series<span class="token punctuation">,</span>y_pred<span class="token punctuation">:</span>pd<span class="token punctuation">.</span>Series<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">'''
    A staticmethod to caculate the KS of the model.
    Args:
        y_true: true value of the sample
        y_pred: pred value of the sample
  
    Returns:
        max(tpr-fpr): KS of the model
    '''</span>
    fpr<span class="token punctuation">,</span>tpr<span class="token punctuation">,</span>_ <span class="token operator">=</span> roc_curve<span class="token punctuation">(</span>y_true<span class="token punctuation">,</span>y_pred<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token builtin">str</span><span class="token punctuation">(</span><span class="token builtin">max</span><span class="token punctuation">(</span><span class="token builtin">abs</span><span class="token punctuation">(</span>tpr<span class="token operator">-</span>fpr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
get_ks_udfs <span class="token operator">=</span> F<span class="token punctuation">.</span>udf<span class="token punctuation">(</span>get_ks<span class="token punctuation">,</span> returnType<span class="token operator">=</span>StringType<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
ksdata <span class="token operator">=</span> spark<span class="token punctuation">.</span>sql<span class="token punctuation">(</span><span class="token string">'select * from tmpview'</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>ksdata<span class="token punctuation">.</span>withColumn<span class="token punctuation">(</span><span class="token string">'eval metrics'</span><span class="token punctuation">,</span>F<span class="token punctuation">.</span>lit<span class="token punctuation">(</span><span class="token string">'KS'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\
    <span class="token punctuation">.</span>groupby<span class="token punctuation">(</span><span class="token string">'eval metrics'</span><span class="token punctuation">)</span>\
    <span class="token punctuation">.</span>agg<span class="token punctuation">(</span>get_ks_udfs<span class="token punctuation">(</span>F<span class="token punctuation">.</span>collect_list<span class="token punctuation">(</span>F<span class="token punctuation">.</span>col<span class="token punctuation">(</span><span class="token string">'y'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>F<span class="token punctuation">.</span>collect_list<span class="token punctuation">(</span>F<span class="token punctuation">.</span>col<span class="token punctuation">(</span><span class="token string">'score'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>alias<span class="token punctuation">(</span><span class="token string">'KS'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\
    <span class="token punctuation">.</span>select<span class="token punctuation">(</span><span class="token string">'KS'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toPandas<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><h1 id="二、auc"><a href="#二、auc" class="header-anchor">#</a> 二、AUC</h1> <p>AUC（Area Under Curve）被定义为 ROC 曲线下与坐标轴围成的面积，通常用来衡量二分类模型全局的区分能力。在 python 和 pyspark 中可以直接调包计算，在 SQL 中可以根据公式计算获得，其计算方法如下：</p> <ol><li><p>对 score 从小到大排序</p></li> <li><p>根据公式计算：</p> <p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>A</mi><mi>U</mi><mi>C</mi><mo>=</mo><mfrac><mrow><msub><mo>∑</mo><mrow><mi>i</mi><mo>∈</mo><mrow><mi>p</mi><mi>o</mi><mi>s</mi><mi>i</mi><mi>t</mi><mi>i</mi><mi>v</mi><mi>e</mi><mi>C</mi><mi>l</mi><mi>a</mi><mi>s</mi><mi>s</mi></mrow></mrow></msub><mi>r</mi><mi>a</mi><mi>n</mi><msub><mi>k</mi><mi>i</mi></msub><mo>−</mo><mfrac><mrow><mi>M</mi><mo>(</mo><mn>1</mn><mo>+</mo><mi>M</mi><mo>)</mo></mrow><mrow><mn>2</mn></mrow></mfrac></mrow><mrow><mi>M</mi><mo>×</mo><mi>N</mi></mrow></mfrac></mrow><annotation encoding="application/x-tex">AUC=\frac{\sum_{i\in{positiveClass}}rank_i-\frac{M(1+M)}{2}}{M\times N}
</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="strut" style="height:1.836118em;"></span><span class="strut bottom" style="height:2.605448em;vertical-align:-0.7693300000000001em;"></span><span class="base displaystyle textstyle uncramped"><span class="mord mathit">A</span><span class="mord mathit" style="margin-right:0.10903em;">U</span><span class="mord mathit" style="margin-right:0.07153em;">C</span><span class="mrel">=</span><span class="mord reset-textstyle displaystyle textstyle uncramped"><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span><span class="mfrac"><span class="vlist"><span style="top:0.686em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle cramped"><span class="mord textstyle cramped"><span class="mord mathit" style="margin-right:0.10903em;">M</span><span class="mbin">×</span><span class="mord mathit" style="margin-right:0.10903em;">N</span></span></span></span><span style="top:-0.22999999999999998em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle uncramped frac-line"></span></span><span style="top:-0.826118em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle uncramped"><span class="mord textstyle uncramped"><span class="mop"><span class="op-symbol small-op mop" style="top:-0.0000050000000000050004em;">∑</span><span class="vlist"><span style="top:0.30001em;margin-right:0.05em;margin-left:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord scriptstyle cramped"><span class="mord mathit">i</span><span class="mrel">∈</span><span class="mord scriptstyle cramped"><span class="mord mathit">p</span><span class="mord mathit">o</span><span class="mord mathit">s</span><span class="mord mathit">i</span><span class="mord mathit">t</span><span class="mord mathit">i</span><span class="mord mathit" style="margin-right:0.03588em;">v</span><span class="mord mathit">e</span><span class="mord mathit" style="margin-right:0.07153em;">C</span><span class="mord mathit" style="margin-right:0.01968em;">l</span><span class="mord mathit">a</span><span class="mord mathit">s</span><span class="mord mathit">s</span></span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mord mathit" style="margin-right:0.02778em;">r</span><span class="mord mathit">a</span><span class="mord mathit">n</span><span class="mord"><span class="mord mathit" style="margin-right:0.03148em;">k</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.03148em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathit">i</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mbin">−</span><span class="mord reset-textstyle textstyle uncramped"><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span><span class="mfrac"><span class="vlist"><span style="top:0.345em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord scriptstyle cramped"><span class="mord mathrm">2</span></span></span></span><span style="top:-0.22999999999999998em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle uncramped frac-line"></span></span><span style="top:-0.485em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle uncramped"><span class="mord scriptstyle uncramped"><span class="mord mathit" style="margin-right:0.10903em;">M</span><span class="mopen">(</span><span class="mord mathrm">1</span><span class="mbin">+</span><span class="mord mathit" style="margin-right:0.10903em;">M</span><span class="mclose">)</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span></span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span></span></span></span></span></span></p> <p>其中，<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>r</mi><mi>a</mi><mi>n</mi><msub><mi>k</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">rank_i</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="strut" style="height:0.69444em;"></span><span class="strut bottom" style="height:0.84444em;vertical-align:-0.15em;"></span><span class="base textstyle uncramped"><span class="mord mathit" style="margin-right:0.02778em;">r</span><span class="mord mathit">a</span><span class="mord mathit">n</span><span class="mord"><span class="mord mathit" style="margin-right:0.03148em;">k</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.03148em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathit">i</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span></span> 代表第 i 个正样本的排序序号，M 和 N 分别代表正样本和负样本的总个数。</p></li></ol> <p>关于该公式的详细理解，可参考 <a href="https://blog.csdn.net/qq_22238533/article/details/78666436" target="_blank" rel="noopener noreferrer">AUC 的计算方法（及评论）<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h2 id="_1-sql-计算-auc"><a href="#_1-sql-计算-auc" class="header-anchor">#</a> 1. SQL 计算 AUC</h2> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">select</span> <span class="token punctuation">(</span>sumpositivernk<span class="token operator">-</span>totalbad<span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">+</span>totalbad<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token punctuation">(</span>totalbad<span class="token operator">*</span>totalgood<span class="token punctuation">)</span> <span class="token keyword">as</span> auc
<span class="token keyword">from</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span> <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">if</span><span class="token punctuation">(</span>y<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>rnk<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">as</span> sumpositivernk<span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span>y<span class="token punctuation">)</span> <span class="token keyword">as</span> totalbad<span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">-</span>y<span class="token punctuation">)</span> <span class="token keyword">as</span> totalgood
    <span class="token keyword">from</span>
    <span class="token punctuation">(</span>
        <span class="token keyword">select</span> y<span class="token punctuation">,</span>row_number<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span> <span class="token punctuation">(</span><span class="token keyword">order</span> <span class="token keyword">by</span> score<span class="token punctuation">)</span> <span class="token keyword">as</span> rnk
        <span class="token keyword">from</span> tmpview
    <span class="token punctuation">)</span>
<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h2 id="_2-python-计算-auc"><a href="#_2-python-计算-auc" class="header-anchor">#</a> 2. Python 计算 AUC</h2> <div class="language-python line-numbers-mode"><pre class="language-python"><code>ksdata <span class="token operator">=</span> spark<span class="token punctuation">.</span>sql<span class="token punctuation">(</span><span class="token string">'select * from tmpview'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toPandas<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>roc_auc_score<span class="token punctuation">(</span>ksdata<span class="token punctuation">[</span><span class="token string">'y'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>ksdata<span class="token punctuation">[</span><span class="token string">'score'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h2 id="_3-pyspark-计算-auc"><a href="#_3-pyspark-计算-auc" class="header-anchor">#</a> 3. Pyspark 计算 AUC</h2> <p>同 KS 的计算，除了提到的两种方式，还可以调用 pyspark 的 ML 包下二分类评价，来计算 AUC</p> <p><strong>a. SQL 逻辑改写</strong></p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>aucdata <span class="token operator">=</span> spark<span class="token punctuation">.</span>sql<span class="token punctuation">(</span><span class="token string">'select * from tmpview'</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">calauc</span><span class="token punctuation">(</span>df<span class="token punctuation">,</span>ycol<span class="token operator">=</span><span class="token string">'y'</span><span class="token punctuation">,</span>scorecol<span class="token operator">=</span><span class="token string">'score'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> df<span class="token punctuation">.</span>withColumn<span class="token punctuation">(</span>ycol<span class="token punctuation">,</span>F<span class="token punctuation">.</span>col<span class="token punctuation">(</span>ycol<span class="token punctuation">)</span><span class="token punctuation">.</span>cast<span class="token punctuation">(</span><span class="token string">'int'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>withColumn<span class="token punctuation">(</span>scorecol<span class="token punctuation">,</span>F<span class="token punctuation">.</span>col<span class="token punctuation">(</span>scorecol<span class="token punctuation">)</span><span class="token punctuation">.</span>cast<span class="token punctuation">(</span><span class="token string">'float'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\
        <span class="token punctuation">.</span>withColumn<span class="token punctuation">(</span><span class="token string">'totalbad'</span><span class="token punctuation">,</span>F<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>F<span class="token punctuation">.</span>col<span class="token punctuation">(</span>ycol<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>over<span class="token punctuation">(</span>Window<span class="token punctuation">.</span>orderBy<span class="token punctuation">(</span>F<span class="token punctuation">.</span>lit<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\
        <span class="token punctuation">.</span>withColumn<span class="token punctuation">(</span><span class="token string">'totalgood'</span><span class="token punctuation">,</span>F<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">-</span>F<span class="token punctuation">.</span>col<span class="token punctuation">(</span>ycol<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>over<span class="token punctuation">(</span>Window<span class="token punctuation">.</span>orderBy<span class="token punctuation">(</span>F<span class="token punctuation">.</span>lit<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\
        <span class="token punctuation">.</span>withColumn<span class="token punctuation">(</span><span class="token string">'rnk2'</span><span class="token punctuation">,</span>F<span class="token punctuation">.</span>row_number<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>over<span class="token punctuation">(</span>Window<span class="token punctuation">.</span>orderBy<span class="token punctuation">(</span>F<span class="token punctuation">.</span>col<span class="token punctuation">(</span>scorecol<span class="token punctuation">)</span><span class="token punctuation">.</span>asc<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\
        <span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>F<span class="token punctuation">.</span>col<span class="token punctuation">(</span>ycol<span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span>\
        <span class="token punctuation">.</span>select<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>F<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>F<span class="token punctuation">.</span>col<span class="token punctuation">(</span><span class="token string">'rnk2'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">0.5</span><span class="token operator">*</span><span class="token punctuation">(</span>F<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span>F<span class="token punctuation">.</span>col<span class="token punctuation">(</span><span class="token string">'totalbad'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">+</span>F<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span>F<span class="token punctuation">.</span>col<span class="token punctuation">(</span><span class="token string">'totalbad'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token punctuation">(</span>F<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span>F<span class="token punctuation">.</span>col<span class="token punctuation">(</span><span class="token string">'totalbad'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">*</span>F<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span>F<span class="token punctuation">.</span>col<span class="token punctuation">(</span><span class="token string">'totalgood'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>alias<span class="token punctuation">(</span><span class="token string">'AUC'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\

calauc<span class="token punctuation">(</span>aucdata<span class="token punctuation">)</span><span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p><strong>b. UDF 函数</strong></p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">auc</span><span class="token punctuation">(</span>ytrue<span class="token punctuation">,</span>ypred<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token builtin">str</span><span class="token punctuation">(</span>roc_auc_score<span class="token punctuation">(</span>ytrue<span class="token punctuation">,</span>ypred<span class="token punctuation">)</span><span class="token punctuation">)</span>
get_auc_udfs <span class="token operator">=</span> F<span class="token punctuation">.</span>udf<span class="token punctuation">(</span>auc<span class="token punctuation">,</span> returnType<span class="token operator">=</span>StringType<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
aucdata <span class="token operator">=</span> spark<span class="token punctuation">.</span>sql<span class="token punctuation">(</span><span class="token string">'select * from tmpview'</span><span class="token punctuation">)</span>
aucdata<span class="token punctuation">.</span>withColumn<span class="token punctuation">(</span><span class="token string">'eval metrics'</span><span class="token punctuation">,</span>F<span class="token punctuation">.</span>lit<span class="token punctuation">(</span><span class="token string">'AUC'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\
    <span class="token punctuation">.</span>groupby<span class="token punctuation">(</span><span class="token string">'eval metrics'</span><span class="token punctuation">)</span>\
    <span class="token punctuation">.</span>agg<span class="token punctuation">(</span>get_auc_udfs<span class="token punctuation">(</span>F<span class="token punctuation">.</span>collect_list<span class="token punctuation">(</span>F<span class="token punctuation">.</span>col<span class="token punctuation">(</span><span class="token string">'y'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>F<span class="token punctuation">.</span>collect_list<span class="token punctuation">(</span>F<span class="token punctuation">.</span>col<span class="token punctuation">(</span><span class="token string">'score'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>alias<span class="token punctuation">(</span><span class="token string">'AUC'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\
      <span class="token punctuation">.</span>select<span class="token punctuation">(</span><span class="token string">'AUC'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p><strong>c. 调包</strong></p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">from</span> pyspark<span class="token punctuation">.</span>ml<span class="token punctuation">.</span>evaluation <span class="token keyword">import</span> BinaryClassificationEvaluator
evaluator <span class="token operator">=</span> BinaryClassificationEvaluator<span class="token punctuation">(</span>rawPredictionCol<span class="token operator">=</span><span class="token string">'score'</span><span class="token punctuation">,</span>labelCol<span class="token operator">=</span><span class="token string">'y'</span><span class="token punctuation">)</span>
aucdata <span class="token operator">=</span> spark<span class="token punctuation">.</span>sql<span class="token punctuation">(</span><span class="token string">'select * from tmpview'</span><span class="token punctuation">)</span>
evaluator<span class="token punctuation">.</span>evaluate<span class="token punctuation">(</span>aucdata<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h1 id="三、psi"><a href="#三、psi" class="header-anchor">#</a> 三、PSI</h1> <p>PSI（Population Stability Index：群体稳定性指标），通常被用于衡量两个样本模型分分布的差异，在风控建模中通常有两个作用：</p> <ol><li>用于建模时筛选掉不稳定的特征</li> <li>用于建模后及上线后评估和监控模型分值的稳定程度</li></ol> <p>个人认为该指标无一个比较明确的标准，在样本量较大的条件下，筛选特征时尽量控制特征 PSI&lt;0.1，或更严格。</p> <p>计算 PSI 首先需要一个分箱基准，假定本文随机生成的模型分的分箱切分点为<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo>[</mo><mn>0</mn><mo separator="true">,</mo><mn>0</mn><mi mathvariant="normal">.</mi><mn>1</mn><mo separator="true">,</mo><mn>0</mn><mi mathvariant="normal">.</mi><mn>2</mn><mo separator="true">,</mo><mn>0</mn><mi mathvariant="normal">.</mi><mn>3</mn><mo separator="true">,</mo><mn>0</mn><mi mathvariant="normal">.</mi><mn>4</mn><mo separator="true">,</mo><mn>0</mn><mi mathvariant="normal">.</mi><mn>5</mn><mo separator="true">,</mo><mn>0</mn><mi mathvariant="normal">.</mi><mn>6</mn><mo separator="true">,</mo><mn>0</mn><mi mathvariant="normal">.</mi><mn>7</mn><mo separator="true">,</mo><mn>0</mn><mi mathvariant="normal">.</mi><mn>8</mn><mo separator="true">,</mo><mn>0</mn><mi mathvariant="normal">.</mi><mn>9</mn><mo separator="true">,</mo><mn>1</mn><mo>]</mo></mrow><annotation encoding="application/x-tex">[0,0.1,0.2,0.3,0.4,0.5,0.6,0.7,0.8,0.9,1]</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="strut" style="height:0.75em;"></span><span class="strut bottom" style="height:1em;vertical-align:-0.25em;"></span><span class="base textstyle uncramped"><span class="mopen">[</span><span class="mord mathrm">0</span><span class="mpunct">,</span><span class="mord mathrm">0</span><span class="mord mathrm">.</span><span class="mord mathrm">1</span><span class="mpunct">,</span><span class="mord mathrm">0</span><span class="mord mathrm">.</span><span class="mord mathrm">2</span><span class="mpunct">,</span><span class="mord mathrm">0</span><span class="mord mathrm">.</span><span class="mord mathrm">3</span><span class="mpunct">,</span><span class="mord mathrm">0</span><span class="mord mathrm">.</span><span class="mord mathrm">4</span><span class="mpunct">,</span><span class="mord mathrm">0</span><span class="mord mathrm">.</span><span class="mord mathrm">5</span><span class="mpunct">,</span><span class="mord mathrm">0</span><span class="mord mathrm">.</span><span class="mord mathrm">6</span><span class="mpunct">,</span><span class="mord mathrm">0</span><span class="mord mathrm">.</span><span class="mord mathrm">7</span><span class="mpunct">,</span><span class="mord mathrm">0</span><span class="mord mathrm">.</span><span class="mord mathrm">8</span><span class="mpunct">,</span><span class="mord mathrm">0</span><span class="mord mathrm">.</span><span class="mord mathrm">9</span><span class="mpunct">,</span><span class="mord mathrm">1</span><span class="mclose">]</span></span></span></span></p> <h2 id="_1-sql-计算-psi"><a href="#_1-sql-计算-psi" class="header-anchor">#</a> 1. SQL 计算 PSI</h2> <div class="language-SQL line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">select</span> 
 <span class="token function">sum</span><span class="token punctuation">(</span>grouppsi<span class="token punctuation">)</span> <span class="token keyword">as</span> psi
 <span class="token keyword">from</span> <span class="token punctuation">(</span>
        <span class="token keyword">select</span> g
        <span class="token punctuation">,</span>log<span class="token punctuation">(</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token function">sum</span><span class="token punctuation">(</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">over</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">0.1</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token function">sum</span><span class="token punctuation">(</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">over</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">0.1</span><span class="token punctuation">)</span> <span class="token keyword">as</span> grouppsi
        <span class="token keyword">from</span> <span class="token punctuation">(</span>
            <span class="token keyword">select</span> 
            <span class="token keyword">case</span> <span class="token keyword">when</span> score<span class="token operator">&lt;</span>cutpoint<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token keyword">then</span> <span class="token number">1</span>
            <span class="token keyword">when</span> score<span class="token operator">&lt;</span>cutpoint<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token keyword">then</span> <span class="token number">2</span>
            <span class="token keyword">when</span> score<span class="token operator">&lt;</span>cutpoint<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token keyword">then</span> <span class="token number">3</span>
            <span class="token keyword">when</span> score<span class="token operator">&lt;</span>cutpoint<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token keyword">then</span> <span class="token number">4</span>
            <span class="token keyword">when</span> score<span class="token operator">&lt;</span>cutpoint<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token keyword">then</span> <span class="token number">5</span>
            <span class="token keyword">when</span> score<span class="token operator">&lt;</span>cutpoint<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span> <span class="token keyword">then</span> <span class="token number">6</span>
            <span class="token keyword">when</span> score<span class="token operator">&lt;</span>cutpoint<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span> <span class="token keyword">then</span> <span class="token number">7</span>
            <span class="token keyword">when</span> score<span class="token operator">&lt;</span>cutpoint<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span> <span class="token keyword">then</span> <span class="token number">8</span>
            <span class="token keyword">when</span> score<span class="token operator">&lt;</span>cutpoint<span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span> <span class="token keyword">then</span> <span class="token number">9</span>
            <span class="token keyword">when</span> score<span class="token operator">&lt;</span>cutpoint<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span> <span class="token keyword">then</span> <span class="token number">10</span> <span class="token keyword">else</span> <span class="token string">'error'</span> <span class="token keyword">end</span> <span class="token keyword">as</span> g
            <span class="token keyword">from</span> <span class="token punctuation">(</span>
                <span class="token keyword">select</span> <span class="token operator">*</span>
                <span class="token punctuation">,</span>array<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0.1</span><span class="token punctuation">,</span><span class="token number">0.2</span><span class="token punctuation">,</span><span class="token number">0.3</span><span class="token punctuation">,</span><span class="token number">0.4</span><span class="token punctuation">,</span><span class="token number">0.5</span><span class="token punctuation">,</span><span class="token number">0.6</span><span class="token punctuation">,</span><span class="token number">0.7</span><span class="token punctuation">,</span><span class="token number">0.8</span><span class="token punctuation">,</span><span class="token number">0.9</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">as</span> cutpoint 
                <span class="token keyword">from</span> tmpview 
                <span class="token punctuation">)</span>
            <span class="token punctuation">)</span>  
        <span class="token keyword">group</span> <span class="token keyword">by</span> g  
    <span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><h2 id="_2-python-计算-psi"><a href="#_2-python-计算-psi" class="header-anchor">#</a> 2. Python 计算 PSI</h2> <div class="language-python line-numbers-mode"><pre class="language-python"><code>psidata <span class="token operator">=</span> spark<span class="token punctuation">.</span>sql<span class="token punctuation">(</span><span class="token string">'select * from tmpview'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toPandas<span class="token punctuation">(</span><span class="token punctuation">)</span>
psidata<span class="token punctuation">[</span><span class="token string">'g'</span><span class="token punctuation">]</span> <span class="token operator">=</span> pd<span class="token punctuation">.</span>cut<span class="token punctuation">(</span>psidata<span class="token punctuation">[</span><span class="token string">'score'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>cut_point<span class="token punctuation">)</span>
psitable <span class="token operator">=</span> psidata<span class="token punctuation">.</span>groupby<span class="token punctuation">(</span><span class="token string">'g'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">'y'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>count<span class="token punctuation">(</span><span class="token punctuation">)</span>
psitable <span class="token operator">/=</span> psitable<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
standratio <span class="token operator">=</span> <span class="token number">1</span><span class="token operator">/</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>cut_point<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
psi <span class="token operator">=</span> <span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">(</span>psitable<span class="token operator">-</span>standratio<span class="token punctuation">)</span><span class="token operator">*</span>np<span class="token punctuation">.</span>log<span class="token punctuation">(</span>psitable<span class="token operator">/</span>standratio<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h2 id="_3-pyspark-计算-psi"><a href="#_3-pyspark-计算-psi" class="header-anchor">#</a> 3. Pyspark 计算 PSI</h2> <p>参考<a href="https://www.jianshu.com/p/649b13e94b87" target="_blank" rel="noopener noreferrer"> Pyspark 实现连续分桶映射并自定义标签<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，调包分箱后按公式计算 PSI</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">from</span> pyspark<span class="token punctuation">.</span>ml<span class="token punctuation">.</span>feature <span class="token keyword">import</span> Bucketizer

<span class="token keyword">def</span> <span class="token function">psi</span><span class="token punctuation">(</span>df<span class="token punctuation">,</span> splits<span class="token punctuation">,</span> inputCol<span class="token punctuation">,</span> outputCol<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>splits<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">:</span>
        <span class="token keyword">raise</span> RuntimeError<span class="token punctuation">(</span><span class="token string">&quot;splits's length must grater then 2.&quot;</span><span class="token punctuation">)</span>

    standratio <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>splits<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    bucketizer <span class="token operator">=</span> Bucketizer<span class="token punctuation">(</span>
        splits<span class="token operator">=</span>splits<span class="token punctuation">,</span> inputCol<span class="token operator">=</span>inputCol<span class="token punctuation">,</span> outputCol<span class="token operator">=</span><span class="token string">'split'</span><span class="token punctuation">)</span>
    with_split <span class="token operator">=</span> bucketizer<span class="token punctuation">.</span>transform<span class="token punctuation">(</span>df<span class="token punctuation">)</span>
    with_split <span class="token operator">=</span> with_split<span class="token punctuation">.</span>groupby<span class="token punctuation">(</span><span class="token string">'split'</span><span class="token punctuation">)</span>\
                            <span class="token punctuation">.</span>agg<span class="token punctuation">(</span><span class="token punctuation">(</span>F<span class="token punctuation">.</span>count<span class="token punctuation">(</span>F<span class="token punctuation">.</span>col<span class="token punctuation">(</span>inputCol<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">/</span>F<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>F<span class="token punctuation">.</span>count<span class="token punctuation">(</span>F<span class="token punctuation">.</span>col<span class="token punctuation">(</span>inputCol<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>over<span class="token punctuation">(</span>Window<span class="token punctuation">.</span>orderBy<span class="token punctuation">(</span>F<span class="token punctuation">.</span>lit<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>alias<span class="token punctuation">(</span><span class="token string">'groupratio'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\
                            <span class="token punctuation">.</span>select<span class="token punctuation">(</span>F<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">(</span>F<span class="token punctuation">.</span>col<span class="token punctuation">(</span><span class="token string">'groupratio'</span><span class="token punctuation">)</span><span class="token operator">-</span>standratio<span class="token punctuation">)</span><span class="token operator">*</span>F<span class="token punctuation">.</span>log<span class="token punctuation">(</span>F<span class="token punctuation">.</span>col<span class="token punctuation">(</span><span class="token string">'groupratio'</span><span class="token punctuation">)</span><span class="token operator">/</span>standratio<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>alias<span class="token punctuation">(</span><span class="token string">'PSI'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  
    <span class="token keyword">return</span> with_split
psi<span class="token punctuation">(</span>aucdata<span class="token punctuation">,</span>cut_point<span class="token punctuation">,</span><span class="token string">'score'</span><span class="token punctuation">,</span><span class="token string">'group'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h1 id="参考资料"><a href="#参考资料" class="header-anchor">#</a> 参考资料</h1> <p><a href="https://tracholar.github.io/machine-learning/2018/01/26/auc.html" target="_blank" rel="noopener noreferrer">深入理解 AUC​<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://unclehuzi.github.io/2021/06/20210619-sql%E8%AE%A1%E7%AE%97psi/" target="_blank" rel="noopener noreferrer">SQL 计算多模型分的 PSI<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://www.jianshu.com/p/649b13e94b87" target="_blank" rel="noopener noreferrer">Pyspark 实现连续分桶映射并自定义标签<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://www.codenong.com/fd299b5e6a402ffa0bec/" target="_blank" rel="noopener noreferrer">使用 pyspark dataframe 的 groupby 计算 AUC<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div></div>  <div class="page-edit"><div class="edit-link"><a href="https://github.com/aka-chestnut/my-vuepress/edit/main/docs/风控基础/1.python、sql、pyspark计算常用风控指标.md" target="_blank" rel="noopener noreferrer">编辑</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="tags"><a href="/tags/?tag=%E9%A3%8E%E6%8E%A7" title="标签">#风控</a><a href="/tags/?tag=%E9%A3%8E%E6%8E%A7%E5%9F%BA%E7%A1%80" title="标签">#风控基础</a></div> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2023/12/29, 15:15:13</span></div></div> <div class="page-nav-wapper"><!----> <!----></div></div> <div class="article-list"><div class="article-title"><a href="/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/pages/risk-dist-score/"><div>
            基于Spark环境的模型分布式打分
            <!----></div></a> <span class="date">12-29</span></dt></dl> <dl><dd></dd> <dt><a href="/archives/" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><div class="icons"><a href="mailto:624409731@qq.com" title="发邮件" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/aka-chestnut" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="https://music.163.com/#/playlist?id=9097954327" title="听音乐" target="_blank" class="iconfont icon-erji"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2019-2024
    <span>Evan Xu | MIT License</span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"><div></div><APlayer audio="" fixed="true" theme="#b7daff" loop="loop" order="list" preload="auto" volume="0.7" mutex="true" lrc-type="3" list-max-height="250" storage-name="vuepress-plugin-meting" id="aplayer-fixed"></APlayer></div></div>
    <script src="/assets/js/app.3258d765.js" defer></script><script src="/assets/js/2.c22fde0b.js" defer></script><script src="/assets/js/15.21c3caba.js" defer></script>
  </body>
</html>
